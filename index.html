<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotella Pizzaria - Seu Pedido</title>
    <!-- Inclui o Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui Font Awesome para o ícone de carrinho -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos personalizados para a fonte Inter e outros ajustes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8; /* Cor de fundo suave */
            color: #333;
            line-height: 1.6;
        }
        /* Definição da fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* Estilo para itens clicáveis */
        .clickable-item {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .clickable-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        /* Estilo para sabores/bebidas desabilitados (aplicado SOMENTE na tela de escolha de sabores) */
        .disabled-option {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8 flex items-center justify-center min-h-screen">
    <div class="container mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 lg:p-10 max-w-3xl border-t-4 border-red-600 relative">
        <!-- Ícone do Carrinho (Visível em todas as telas controladas por showPage) -->
        <div id="cart-icon-container" class="absolute top-4 right-4 cursor-pointer flex items-center justify-center bg-red-600 text-white rounded-full p-3 shadow-lg hover:bg-red-700 transition-colors z-10" onclick="showPage('order-summary')">
            <i class="fas fa-shopping-cart text-xl"></i>
            <span id="cart-count" class="ml-2 text-lg font-bold">0</span>
        </div>

        <!-- Título da Pizzaria (visível em todas as "páginas") -->
        <h1 class="text-4xl sm:text-5xl font-extrabold text-red-700 text-center mb-6 mt-4">Rotella Pizzaria</h1>

        <!-- Seção do Cardápio Principal -->
        <div id="main-menu" class="page-section">
            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-800 text-center mb-8">Nosso Cardápio Delicioso!</h2>

            <!-- Seção de Combos Especiais -->
            <div class="mb-10">
                <h3 class="text-2xl sm:text-2xl font-bold text-red-600 border-b-2 border-red-400 pb-2 mb-6">Combos Especiais</h3>
                <p class="text-sm text-gray-600 mb-4 italic text-center">
                    *Obs: Válido somente para sabores tradicionais de pizza.
                </p>
                
                <!-- Item do Combo 1 (Clicável) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-3 rounded-lg border border-gray-200 mb-4 clickable-item"
                     data-item-type="combo" data-item-id="combo1" data-item-name="Combo 1" data-item-price="39.90">
                    <div class="flex-grow">
                        <p class="text-lg font-bold text-gray-900">Combo 1</p>
                        <p class="text-sm text-gray-600 mt-1">Pizza grande (até dois sabores) + Coca-cola de 1L</p>
                    </div>
                    <p class="text-xl font-extrabold text-red-700 mt-2 sm:mt-0">R$ 39,90</p>
                </div>

                <!-- Item do Combo 2 (Clicável) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-3 rounded-lg border border-gray-200 mb-4 clickable-item"
                     data-item-type="combo" data-item-id="combo2" data-item-name="Combo 2" data-item-price="74.90">
                    <div class="flex-grow">
                        <p class="text-lg font-bold text-gray-900">Combo 2</p>
                        <p class="text-sm text-gray-600 mt-1">2 Pizzas grandes (até dois sabores cada) + Coca-cola de 2L</p>
                    </div>
                    <p class="text-xl font-extrabold text-red-700 mt-2 sm:mt-0">R$ 74,90</p>
                </div>
            </div>

            <!-- Seção de Pizzas -->
            <div class="mb-10">
                <h3 class="text-2xl sm:text-2xl font-bold text-red-600 border-b-2 border-red-400 pb-2 mb-6">Pizzas</h3>
                <!-- Item Pizza Grande Tradicional (Clicável) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-3 rounded-lg border border-gray-200 mb-4 clickable-item"
                     data-item-type="pizza-tradicional" data-item-id="pizza-tradicional-grande" data-item-name="Pizza Grande Tradicional" data-item-price="34.90">
                    <div class="flex-grow">
                        <p class="text-lg font-bold text-gray-900">Pizza Grande Tradicional</p>
                        <p class="text-sm text-gray-600 mt-1">Até dois sabores</p>
                    </div>
                    <p class="text-xl font-extrabold text-red-700 mt-2 sm:mt-0">R$ 34,90</p>
                </div>
                <!-- Item Pizza Grande Especial (Clicável) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-3 rounded-lg border border-gray-200 mb-4 clickable-item"
                     data-item-type="pizza-especial" data-item-id="pizza-especial-grande" data-item-name="Pizza Grande Especial" data-item-price="44.90">
                    <div class="flex-grow">
                        <p class="text-lg font-bold text-gray-900">Pizza Grande Especial</p>
                        <p class="text-sm text-gray-600 mt-1">Até dois sabores</p>
                    </div>
                    <p class="text-xl font-extrabold text-red-700 mt-2 sm:mt-0">R$ 44,90</p>
                </div>
                <!-- Item Pizza Média Tradicional (Clicável) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-3 rounded-lg border border-gray-200 mb-4 clickable-item"
                     data-item-type="pizza-media" data-item-id="pizza-media" data-item-name="Pizza Média Tradicional" data-item-price="29.90">
                    <div class="flex-grow">
                        <p class="text-lg font-bold text-gray-900">Pizza Média Tradicional</p>
                        <p class="text-sm text-gray-600 mt-1">Até dois sabores</p>
                    </div>
                    <p class="text-xl font-extrabold text-red-700 mt-2 sm:mt-0">R$ 29,90</p>
                </div>
                <!-- Item Pizza Média Especial (Clicável) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-3 rounded-lg border border-gray-200 mb-4 clickable-item"
                     data-item-type="pizza-especial" data-item-id="pizza-especial-media" data-item-name="Pizza Média Especial" data-item-price="39.90">
                    <div class="flex-grow">
                        <p class="text-lg font-bold text-gray-900">Pizza Média Especial</p>
                        <p class="text-sm text-gray-600 mt-1">Até dois sabores</p>
                    </div>
                    <p class="text-xl font-extrabold text-red-700 mt-2 sm:mt-0">R$ 39,90</p>
                </div>
            </div>
            
        </div>

        <!-- Seção de Seleção de Sabores e Bebidas -->
        <div id="flavor-selection" class="page-section hidden">
            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-800 text-center mb-8">Personalize seu Pedido</h2>

            <div id="item-info" class="text-center text-lg text-gray-700 mb-6 p-4 bg-red-50 rounded-lg">
                <!-- Informações do item selecionado serão carregadas aqui pelo JS -->
            </div>

            <!-- Seção de Sabores -->
            <div class="mb-10">
                <h3 class="text-2xl sm:text-2xl font-bold text-red-600 border-b-2 border-red-400 pb-2 mb-6">Selecione seus Sabores</h3>
                <p id="flavor-instruction-text" class="text-md text-gray-600 text-center mb-6">
                    <!-- Este texto será atualizado dinamicamente -->
                </p>

                <div id="flavor-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <!-- Sabores tradicionais -->
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Portuguesa" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Portuguesa</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Calabresa" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Calabresa</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Mussarela" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Mussarela</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Marguerita" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Marguerita</span>
                    </label>
                    <!-- Sabores especiais -->
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Frango com Catupiry" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Frango com Catupiry</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Calabresa com Catupiry" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Calabresa com Catupiry</span>
                    </label>
                    <!-- Sabores doces -->
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Brigadeiro" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Brigadeiro</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Romeu e Julieta" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Romeu e Julieta</span>
                    </label>
                    <!-- Outros sabores -->
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Pepperoni" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Pepperoni</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="checkbox" name="flavor" value="Quatro Queijos" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Quatro Queijos</span>
                    </label>
                </div>
            </div>

            <!-- Seção de Bebidas -->
            <div class="mb-10">
                <h3 class="text-2xl sm:text-2xl font-bold text-red-600 border-b-2 border-red-400 pb-2 mb-6">Selecione sua Bebida (Opcional)</h3>
                <div id="beverage-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="radio" name="beverage" value="Coca-cola 1L" data-beverage-price="9.90" data-beverage-id="coca-1l" class="form-radio h-5 w-5 text-red-600 focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Coca-cola 1L - R$ 9,90</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="radio" name="beverage" value="Coca-cola 2L" data-beverage-price="13.90" data-beverage-id="coca-2l" class="form-radio h-5 w-5 text-red-600 focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Coca-cola 2L - R$ 13,90</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="radio" name="beverage" value="Fanta Laranja 2L" data-beverage-price="12.90" data-beverage-id="fanta-2l" class="form-radio h-5 w-5 text-red-600 focus:ring-red-500">
                        <span class="ml-3 text-lg text-gray-800 font-medium">Fanta Laranja 2L - R$ 12,90</span>
                    </label>
                    <!-- Opção "Nenhuma bebida" -->
                    <label class="flex items-center p-3 border rounded-lg shadow-sm hover:shadow-md transition-all cursor-pointer bg-white">
                        <input type="radio" name="beverage" value="Nenhuma bebida" data-beverage-price="0.00" data-beverage-id="no-beverage" class="form-radio h-5 w-5 text-red-600 focus:ring-red-500" checked>
                        <span class="ml-3 text-lg text-gray-800 font-medium">Nenhuma bebida</span>
                    </label>
                </div>
            </div>

            <div class="text-center space-x-4">
                <button id="add-to-cart-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" disabled>
                    Adicionar ao Carrinho
                </button>
                <button onclick="showPage('main-menu')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Voltar ao Cardápio
                </button>
            </div>
        </div>

        <!-- Seção de Resumo do Pedido (Carrinho de Compras) -->
        <div id="order-summary" class="page-section hidden">
            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-800 text-center mb-8">Seu Carrinho</h2>

            <div id="cart-items-container" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <!-- Itens do carrinho serão inseridos aqui dinamicamente -->
                <p id="empty-cart-message" class="text-center text-gray-600 italic hidden">Seu carrinho está vazio.</p>
            </div>

            <!-- Campo de CEP e Cálculo de Entrega -->
            <div class="mb-6 p-4 border rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-bold text-gray-800 mb-3">Calculo de Entrega</h3>
                <p class="text-sm text-gray-600 mb-2">CEP de Origem: 69095510</p>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="delivery-zip-code" placeholder="Digite o CEP de destino" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" maxlength="8">
                    <button id="calculate-delivery-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Calcular Taxa
                    </button>
                </div>
                <p id="delivery-info" class="text-md text-gray-700 mt-3"></p>
            </div>

            <div class="text-right text-3xl font-extrabold text-red-700 mt-6 pt-4 border-t-2 border-red-300 mb-8">
                <span class="font-semibold">Total do Pedido:</span> <span id="cart-total-price">R$ 0,00</span>
            </div>

            <div class="text-center space-x-4">
                <button id="place-order-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" disabled>
                    Finalizar Pedido
                </button>
                <button onclick="showPage('main-menu')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Voltar ao Cardápio
                </button>
            </div>
        </div>
        
        <!-- Mensagem de rodapé (visível em todas as "páginas") -->
        <p class="text-center text-gray-500 text-sm mt-10">Obrigado por escolher Rotella Pizzaria! Bom apetite!</p>
    </div>

    <script>
        // Array para armazenar os itens no carrinho (pizza/combo e bebidas separadas)
        let cart = []; 
        let selectedItem = {}; // Item (pizza/combo) sendo configurado na tela de seleção de sabores
        let selectedBeverage = { name: 'Nenhuma bebida', price: 0, id: 'no-beverage' }; // Bebida selecionada na tela de seleção
        let deliveryFee = 0; // Armazena a taxa de entrega calculada

        const ORIGIN_ZIP_CODE = '69095510'; // CEP de origem fixo
        // Chave de API atualizada conforme sua solicitação
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBd6-d4xDeEdHCILpv_c5xqGTBAR8o8xm4'; 

        // Função para mostrar a página correta e esconder as outras
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');

            // Se for para a página de resumo, atualiza o carrinho
            if (pageId === 'order-summary') {
                renderCart();
            }
        }

        // Função para atualizar a contagem de itens no ícone do carrinho
        function updateCartIconCount() {
            let totalItemsInCart = 0;
            cart.forEach(item => {
                totalItemsInCart += item.quantity;
            });
            document.getElementById('cart-count').textContent = totalItemsInCart;
        }

        // === Lógica do Cardápio Principal ===
        document.querySelectorAll('.clickable-item').forEach(item => {
            item.addEventListener('click', function() {
                selectedItem = {
                    type: this.dataset.itemType, // 'combo', 'pizza-tradicional', 'pizza-especial', 'pizza-media'
                    id: this.dataset.itemId,
                    name: this.dataset.itemName,
                    price: parseFloat(this.dataset.itemPrice)
                };
                
                // Reinicia os checkboxes de sabor e o botão ao ir para seleção de sabores
                document.querySelectorAll('input[name="flavor"]').forEach(cb => {
                    cb.checked = false;
                    cb.disabled = false;
                    cb.closest('label').classList.remove('disabled-option'); // Remove o estilo de desabilitado
                });
                
                // Reinicia a seleção de bebida para "Nenhuma bebida"
                selectedBeverage = { name: 'Nenhuma bebida', price: 0, id: 'no-beverage' };
                document.querySelectorAll('input[name="beverage"]').forEach(radio => {
                    radio.checked = (radio.value === 'Nenhuma bebida'); // Marca a opção "Nenhuma bebida"
                });

                // Atualiza o texto de instrução da seleção de sabores e o estado do botão
                updateFlavorSelectionInstructions();
                updateFinalizeButtonState(); 
                
                // Atualiza as informações do item na página de seleção de sabores
                document.getElementById('item-info').innerHTML = `Você selecionou: <span class="font-bold">${selectedItem.name}</span> por <span class="font-bold">R$ ${selectedItem.price.toFixed(2).replace('.', ',')}</span>`;
                
                // Redireciona para a seleção de sabor para combos e pizzas que exigem sabor
                if (selectedItem.type === 'combo' || selectedItem.id === 'pizza-tradicional-grande' || selectedItem.type === 'pizza-especial' || selectedItem.id === 'pizza-media') {
                    showPage('flavor-selection');
                } else {
                    // Para outros itens que não precisam de seleção de sabor (se houver no futuro)
                    // Adiciona o item diretamente ao carrinho se não precisar de seleção de sabor
                    cart.push({
                        name: selectedItem.name,
                        price: selectedItem.price,
                        quantity: 1,
                        flavors: [],
                        type: selectedItem.type,
                        id: selectedItem.id 
                    });
                    renderCart(); // Renderiza o carrinho e atualiza o ícone (chamado aqui para itens sem seleção)
                    showPage('order-summary');
                }
            });
        });

        // === Lógica da Seleção de Sabores e Bebidas ===
        const flavorCheckboxes = document.querySelectorAll('input[name="flavor"]');
        const beverageRadios = document.querySelectorAll('input[name="beverage"]');
        const addToCartBtn = document.getElementById('add-to-cart-btn'); // Botão "Adicionar ao Carrinho"
        const flavorInstructionText = document.getElementById('flavor-instruction-text');

        const traditionalFlavors = ['Portuguesa', 'Calabresa', 'Mussarela', 'Marguerita'];

        // Função para atualizar as instruções de seleção de sabor e habilitar/desabilitar checkboxes
        function updateFlavorSelectionInstructions() {
            // Re-habilita todos os checkboxes inicialmente antes de aplicar novas restrições
            flavorCheckboxes.forEach(cb => {
                cb.disabled = false;
                cb.closest('label').classList.remove('disabled-option');
            });

            if (selectedItem.id === 'combo2') {
                flavorInstructionText.textContent = 'Para o Combo 2 (2 pizzas grandes), escolha até 4 sabores (2 por pizza).';
                // Para combos, apenas sabores tradicionais são permitidos
                flavorCheckboxes.forEach(cb => {
                    if (!traditionalFlavors.includes(cb.value)) {
                        cb.disabled = true;
                        cb.closest('label').classList.add('disabled-option');
                    }
                });
            } else if (selectedItem.id === 'combo1' || selectedItem.id === 'pizza-tradicional-grande' || selectedItem.id === 'pizza-media') {
                flavorInstructionText.textContent = 'Escolha até 2 sabores para sua pizza. Se selecionar apenas 1, a pizza será inteira desse sabor.';
                // Para Combo 1, Pizza Grande Tradicional e Pizza Média, apenas sabores tradicionais são permitidos
                flavorCheckboxes.forEach(cb => {
                    if (!traditionalFlavors.includes(cb.value)) {
                        cb.disabled = true;
                        cb.closest('label').classList.add('disabled-option');
                    }
                });
            } else if (selectedItem.id === 'pizza-especial-grande' || selectedItem.id === 'pizza-especial-media') {
                flavorInstructionText.textContent = `Para sua ${selectedItem.name}, escolha até 2 sabores. Se selecionar apenas 1, a pizza será inteira desse sabor.`;
                // Para Pizzas Especiais (grande e média), todos os sabores são permitidos
            } else {
                flavorInstructionText.textContent = 'Escolha seus sabores.'; // Genérico para outros itens
            }
        }

        // Adiciona listener para cada checkbox de sabor
        flavorCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('input[name="flavor"]:checked').length;
                let maxAllowedFlavors;

                if (selectedItem.id === 'combo2') {
                    maxAllowedFlavors = 4;
                } else if (selectedItem.id === 'combo1' || selectedItem.id === 'pizza-tradicional-grande' || selectedItem.id === 'pizza-especial-grande' || selectedItem.id === 'pizza-media' || selectedItem.id === 'pizza-especial-media') {
                    maxAllowedFlavors = 2; // Combos de 1 pizza e todas as pizzas individuais permitem 2 sabores
                } else {
                    maxAllowedFlavors = 2; // Padrão
                }

                if (checkedCount >= maxAllowedFlavors) {
                    flavorCheckboxes.forEach(cb => {
                        // Só desabilita se não estiver checado E se não for um sabor já desabilitado pela categoria (ex: não tradicional)
                        if (!cb.checked && !cb.disabled) { 
                            cb.disabled = true;
                        }
                    });
                } else {
                    // Re-habilita os checkboxes que não foram desabilitados por restrição de categoria de pizza
                    flavorCheckboxes.forEach(cb => {
                        if (!cb.checked) { // Se não estiver checado
                            if (selectedItem.type === 'combo' || selectedItem.id === 'pizza-tradicional-grande' || selectedItem.id === 'pizza-media') {
                                // Se for um tipo que restringe a tradicionais, só re-habilita se for tradicional
                                if (traditionalFlavors.includes(cb.value)) {
                                    cb.disabled = false;
                                }
                            } else { // Para tipos que permitem todos os sabores (ex: Pizza Especial)
                                cb.disabled = false;
                            }
                        }
                    });
                }
                updateFinalizeButtonState();
            });
        });

        // Adiciona listener para cada radio button de bebida
        beverageRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                selectedBeverage = {
                    name: radio.value,
                    price: parseFloat(radio.dataset.beveragePrice),
                    id: radio.dataset.beverageId // Adiciona o ID da bebida
                };
                updateFinalizeButtonState(); 
            });
        });


        // Função para atualizar o estado do botão "Adicionar ao Carrinho"
        function updateFinalizeButtonState() {
            const checkedFlavorsCount = document.querySelectorAll('input[name="flavor"]:checked').length;
            let minFlavorsToEnableButton;

            // Determina o número mínimo de sabores para habilitar o botão
            if (selectedItem.id === 'combo2') {
                minFlavorsToEnableButton = 2;
            } else if (selectedItem.type === 'combo' || selectedItem.id === 'pizza-tradicional-grande' || selectedItem.id === 'pizza-especial-grande' || selectedItem.id === 'pizza-media' || selectedItem.id === 'pizza-especial-media') {
                minFlavorsToEnableButton = 1;
            } else {
                minFlavorsToEnableButton = 0; 
            }

            // O botão "Adicionar ao Carrinho" é habilitado se a condição de sabores for atendida
            const isFlavorConditionMet = checkedFlavorsCount >= minFlavorsToEnableButton;
            addToCartBtn.disabled = !isFlavorConditionMet; // Usa addToCartBtn
        }

        // Evento de clique para o botão "Adicionar ao Carrinho"
        addToCartBtn.addEventListener('click', () => { // Usa addToCartBtn
            const selectedFlavors = Array.from(document.querySelectorAll('input[name="flavor"]:checked'))
                                       .map(cb => cb.value);
            
            // Adiciona a pizza/combo ao carrinho
            cart.push({
                name: selectedItem.name,
                price: selectedItem.price,
                quantity: 1, 
                flavors: selectedFlavors,
                type: selectedItem.type,
                id: selectedItem.id 
            });

            // Se uma bebida foi selecionada (e não é "Nenhuma bebida"), adicione-a como um item separado
            if (selectedBeverage.name !== 'Nenhuma bebida') {
                cart.push({
                    name: selectedBeverage.name,
                    price: selectedBeverage.price,
                    quantity: 1, // Bebida é adicionada como 1 unidade por padrão
                    type: 'beverage', // Novo tipo para bebidas
                    id: selectedBeverage.id 
                });
            }

            updateCartIconCount(); // Atualiza a contagem no ícone do carrinho
            showPage('order-summary'); // Vai para a tela de resumo/carrinho
        });

        // === Lógica do Carrinho de Compras / Resumo ===
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalPriceElement = document.getElementById('cart-total-price');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const deliveryZipCodeInput = document.getElementById('delivery-zip-code');
        const calculateDeliveryBtn = document.getElementById('calculate-delivery-btn');
        const deliveryInfoElement = document.getElementById('delivery-info');


        function renderCart() {
            cartItemsContainer.innerHTML = ''; // Limpa o conteúdo atual do carrinho
            
            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                placeOrderBtn.disabled = true;
            } else {
                emptyCartMessage.classList.add('hidden');
                placeOrderBtn.disabled = false;

                cart.forEach((item, index) => {
                    let itemDisplayPrice = item.price; // Preço unitário para exibição
                    let itemDescription = '';

                    if (item.type === 'beverage') {
                        itemDescription = `Bebida: ${item.name}`;
                    } else { // É uma pizza ou combo
                        // Monta o texto dos sabores
                        let flavorsText = '';
                        if (item.flavors && item.flavors.length > 0) {
                            if (item.flavors.length === 1) {
                                flavorsText = `${item.flavors[0]} (inteira)`;
                            } else if (item.flavors.length === 2 && (item.id === 'combo1' || item.id === 'pizza-tradicional-grande' || item.id === 'pizza-especial-grande' || item.id === 'pizza-media' || item.id === 'pizza-especial-media')) {
                                flavorsText = `${item.flavors[0]} e ${item.flavors[1]}`;
                            } else if (item.flavors.length >= 2 && item.id === 'combo2') { 
                                flavorsText = item.flavors.slice(0, -1).join(', ') + ' e ' + item.flavors[item.flavors.length - 1];
                            }
                        } else {
                            flavorsText = 'N/A';
                        }
                        itemDescription = `Sabores: ${flavorsText}`;
                    }
                    
                    const cartItemHtml = `
                        <div class="flex items-center justify-between py-3 border-b border-gray-200 last:border-b-0">
                            <div class="flex-grow">
                                <p class="text-lg font-bold text-gray-900">${item.name}</p>
                                <p class="text-sm text-gray-600">${itemDescription}</p>
                                <p class="text-sm text-gray-700 font-semibold">R$ ${itemDisplayPrice.toFixed(2).replace('.', ',')} /un</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="updateQuantity(${index}, -1)" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">-</button>
                                <span class="text-xl font-bold">${item.quantity}</span>
                                <button onclick="updateQuantity(${index}, 1)" class="bg-green-500 hover:bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">+</button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.innerHTML += cartItemHtml;
                });
                updateCartIconCount(); // Atualiza a contagem no ícone do carrinho
            }
            calculateTotalCartPrice(); // Recalcula o total (incluindo a taxa de entrega)
        }

        // Função para atualizar a quantidade de um item no carrinho
        function updateQuantity(index, change) {
            if (cart[index]) {
                cart[index].quantity += change;
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1); // Remove o item se a quantidade for 0 ou menos
                }
            }
            renderCart(); // Re-renderiza o carrinho para refletir as mudanças
        }

        // Função para calcular a taxa de entrega com base na distância
        function calculateDeliveryFee(distance) {
            if (distance <= 5) return 5.00;
            if (distance <= 10) return 7.00;
            if (distance <= 15) return 12.00;
            if (distance <= 20) return 15.00;
            return 25.00;
        }

        // Função para obter a distância via Google Maps Distance Matrix API
        async function getDistanceViaGoogleMapsAPI(originZip, destinationZip) {
            const url = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${originZip}&destinations=${destinationZip}&units=metric&key=${GOOGLE_MAPS_API_KEY}`;
            
            try {
                const response = await fetch(url);
                // Check for HTTP errors before parsing JSON
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Erro da API Google Maps: ${response.status} - ${response.statusText}`, errorText);
                    return null; 
                }
                const data = await response.json();

                if (data.status === 'OK' && data.rows.length > 0 && data.rows[0].elements.length > 0 && data.rows[0].elements[0].status === 'OK') {
                    const distanceInMeters = data.rows[0].elements[0].distance.value;
                    return distanceInMeters / 1000; // Converte metros para quilômetros
                } else {
                    console.error('Erro ao obter distância da API Google Maps (status não OK ou dados ausentes):', data.status, data);
                    return null; // Retorna null se não conseguir obter a distância
                }
            } catch (error) {
                // Este bloco catch lida com erros de rede (como "Failed to fetch" devido a CORS ou problemas de rede reais)
                console.error('Erro na requisição da API de distância (pode ser problema de CORS, chave inválida ou rede):', error);
                return null; 
            }
        }

        // Função para simular a distância caso a API falhe ou esteja desativada
        function getSimulatedDistance(destinationZip) {
            if (destinationZip && destinationZip.startsWith('69095')) { 
                return 3.5; // km
            } else if (destinationZip && destinationZip.startsWith('69085')) { 
                return 8.2; // km
            } else if (destinationZip && destinationZip.startsWith('69099')) {
                return 13.0; // km
            } else if (destinationZip && destinationZip.startsWith('69000')) {
                return 18.0; // km
            } else {
                return 25.0; // km (distância alta para taxa alta)
            }
        }


        // Função para calcular e exibir o total do carrinho, incluindo a taxa de entrega
        function calculateTotalCartPrice() {
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            let total = subtotal + deliveryFee;
            cartTotalPriceElement.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        // Evento para o botão "Calcular Taxa"
        calculateDeliveryBtn.addEventListener('click', async () => {
            const destinationZip = deliveryZipCodeInput.value.replace(/\D/g, ''); // Remove caracteres não numéricos
            deliveryFee = 0; // Zera a taxa antes de recalcular
            deliveryInfoElement.textContent = 'Calculando...';

            if (destinationZip.length === 8) {
                let distance = null;
                // Tenta obter a distância da API real
                distance = await getDistanceViaGoogleMapsAPI(ORIGIN_ZIP_CODE, destinationZip);
                
                if (distance !== null) { // Se a API real funcionar
                    deliveryFee = calculateDeliveryFee(distance);
                    deliveryInfoElement.textContent = `Distância (API Real): ${distance.toFixed(1).replace('.', ',')} km. Taxa de entrega: R$ ${deliveryFee.toFixed(2).replace('.', ',')}.`;
                } else {
                    // Se a API falhar, usa a simulação
                    distance = getSimulatedDistance(destinationZip);
                    deliveryFee = calculateDeliveryFee(distance);
                    deliveryInfoElement.textContent = `Distância (Simulada): ${distance.toFixed(1).replace('.', ',')} km. Taxa de entrega: R$ ${deliveryFee.toFixed(2).replace('.', ',')}. (Não foi possível conectar à API de mapas - usando simulação)`;
                }
            } else {
                deliveryInfoElement.textContent = 'Por favor, digite um CEP válido (8 dígitos).';
            }
            calculateTotalCartPrice(); // Atualiza o total com a nova taxa de entrega
        });

        // Inicializa mostrando a página do cardápio principal e atualiza o ícone do carrinho
        document.addEventListener('DOMContentLoaded', () => {
            showPage('main-menu');
            updateCartIconCount(); // Garante que a contagem do carrinho seja exibida corretamente ao carregar
        });
    </script>
</body>
</html>
